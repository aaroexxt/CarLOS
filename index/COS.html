<!DOCTYPE HTML>
<html> <!-- manifest="data.appcache" -->
	<head>
		<title>C.OS. V1</title>
		<script src="/js/socket.io.js"></script>
		<script src="/js/helpLib.js"></script>
		<script src="/js/utils.js"></script>
		<script src="/js/speaker.js"></script>
		<script src="/js/annyang.js"></script>
		<script src="/js/globals.js"></script>
		<script src="/js/speechkitt.min.js"></script>
		<script src="/js/jquery-3.3.1.min.js"></script>
		<script src="/js/bootbox.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/Chart.min.js"></script>
		<script src="/js/soundcloudSDK-3.3.0.js"></script>
		<!--<script src="https://connect.soundcloud.com/sdk/sdk-3.3.0.js"></script>-->
		<link rel="stylesheet" type="text/css" media="screen" href="/css/style.css">
		<link rel="stylesheet" type="text/css" media="screen" href="/css/bootstrap.min.css">
		<link rel="shortcut icon" href="/favicon.ico" />
		<meta charset="UTF-8">
	</head>
	<body>
		<div id="main" class="mapWrapper" style="display: none;">
			<ul class="menutop" style="transform: translateX(-6px)">
				<li style="font-size: 14px; font-family: 'Helvetica Neue'; transform: none !important; float: left; margin-left: 1%; margin-top: 17px;" id="extTemp">EXT: ?°F</li>
				<li style="font-size: 14px; font-family: 'Helvetica Neue'; transform: none !important; float: left; margin-left: 1%; margin-top: 17px; display: none;" id="intTemp">INT: ?°F</li>
				<li style="font-size: 14px; font-family: 'Helvetica Neue'; transform: none !important; font-weight: 300">Welcome to CarOS</li>
				<li class="menubreaker">|</li>
				<li><img src="/images/music.png" width="35" height="35" id="menuButtonMusic" onclick="globals.menu.changeState('music');" class="circle"></img></li>
				<li class="menubreaker">|</li>
				<li><img src="/images/browser.png" width="35" height="35" id="menuButtonBrowser" onclick="globals.menu.changeState('browser');" class="circle"></img></li>
				<li class="menubreaker">|</li>
				<li><img src="/images/a.png" width="40" height="40" onclick="globals.updateRuntimeInformation(); socketListener.addListener('runtimeInformation', function(){setTimeout(function(){globals.MainPopup.displayMain()},50);});"></img></li>
				<li class="menubreaker">|</li>
				<li><img src="/images/stats.png" width="35" height="35" id="menuButtonStats" onclick="globals.menu.changeState('stats');" class="circle"></img></li>
				<li class="menubreaker">|</li>
				<li><img src="/images/map.png" width="35" height="35" id="menuButtonMap" onclick="globals.menu.changeState('map');" class="circle"></img></li>
				<li class="menubreaker">|&nbsp;&nbsp;&nbsp;</li>
				<li class="menuitemnoanim"><p id="time" style="min-width: 150px !important; font-size: 17px; font-family: 'Helvetica Neue';">12:00 AM</p></li> <!-- Does min-width even work? Fix for tmrw-->
				<li class="menuitemnoanim" id="wifispeed" style="font-size: 14px; transform: none !important; font-family: 'Helvetica Neue'; float: right; margin-right: 1%; margin-top: 20px;">1 MB/S</li>
				<li class="menuitemnoanim" style="transform: none !important; font-family: 'Helvetica Neue'; float: right; margin-right: 1%; margin-top: 17px;">
					<img src="/images/wifi0.png" width="40" height="27" id="wifilevel"></img>
				</li>
			</ul>
			<div id="mainMap" class="fullScreenMap" style="display: none">
				<br>
				<br>
				<br>
				<h1>Loading...</h1>
			</div>
			<div id="mainMusic" class="fullScreen" style="display: none">
				<img width="23.5%" height="45%px" style="float: left; margin-left: 1%; margin-top: 1%; border: 2px groove grey;" id="music_trackArt"></img> <!--always 500px by 500px-->
				<div style="float: left; margin-left: 1%; margin-top: 1%; width: 74%; font-family: 'Helvetica Neue';">
					<center>
						<h1 id="music_trackTitle" class="shadow">Tracks loading...</h1>
						<h3 id="music_trackAuthor" style="margin-left: 10%;"></h3>
					</center>
				</div>
				<img width="74%" height="10%" style="float: left; margin-left: 1%" id="music_waveformArt"></img> <!--always 1800px by 280px-->
				<img width="74%" height="10%" style="float: left; margin-left: 1%" id="music_waveformArtBufferCanvas"></img>
				<img width="74%" height="10%" style="float: left; margin-left: 1%" id="music_waveformArtCanvas"></img>
				<div id="music_trackList" style="width: 99%; margin-left: 1%; height: 30%; overflow: scroll; overflow-x: hidden;">
				</div>
			</div>
			<ul class="menubottom" id="music_bottomMenu" style="display: none;">
				<li style="transform: none !important; float: right; margin-right: 1%; position: absolute; bottom: 20%; left: 91%;"><img src="/images/soundcloudAttribution.png"></img></li>
				<li style="transform: none !important; float: left; margin-left: 1%; position: absolute; bottom: 25%; right: 86%; width: 175px;"><button class="sort" onclick="globals.music.musicUI.changeSoundcloudUser();" style="font-family: 'Helvetica Neue';">Change Soundcloud User</button></li>
				<li class="controlButton" onclick="globals.music.soundManager.changeShuffleState(); if (globals.music.nextTrackShuffle) {this.className+=' activeLoopShuffle';} else {this.className = 'controlButton';}" id="music_shuffleButton"><img src="/images/shuffle.png" width="20px" height="20px"></img></li>
				<li class="menubreaker">|</li>
				<li class="controlButton" onclick="globals.music.soundManager.volDown();">Vol -</li>
				<li class="menubreaker">|</li>
				<li class="controlButton" onclick="globals.music.soundManager.backTrack(1);">◅◅◅</li>
				<li class="menubreaker">|</li>
				<li class="controlButton playPause" onclick="globals.music.soundManager.playPauseTrack();">▶❚❚</li><!--▷-->
				<li class="menubreaker">|</li>
				<li class="controlButton" onclick="globals.music.soundManager.forwardTrack(1);">▻▻▻</li>
				<li class="menubreaker">|</li>
				<li class="controlButton" onclick="globals.music.soundManager.volUp();">Vol +</li>
				<li class="menubreaker">|</li>
				<li class="controlButton" onclick="globals.music.soundManager.changeLoopState(); if (globals.music.nextTrackLoop) {this.className+=' activeLoopShuffle';} else {this.className = 'controlButton';}" id="music_loopButton"><img src="/images/repeat.png" width="20px" height="20x"></img></li>
			</ul>
			<div id="mainBrowser" class="fullScreen" style="display: none">
				<gcse:search class="fullScreen" id="gcsescpt">Loading browser...</gcse:search>
				<script>
					(function() {
					  var cx = '004200655191535526828:9bdqifawysu'; // Insert your own Custom Search engine ID here
					  var gcse = document.createElement('script');
					  gcse.type = 'text/javascript';
					  gcse.async = true;
					  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
					  var s = document.getElementById("gcsescpt"); s.parentNode.insertBefore(gcse, s);
					})();
				</script>
			</div>
			<div id="mainStats" class="fullScreen" style="display: none">
				<center>
					<h2 style="text-decoration: underline;">Car Usage Statistics</h2>
				</center>
					<canvas id="carStats" width="100%" height="100%"></canvas>
			</div>
		</div>
		<div id="loading">
			<center>
				<h1>Connected to server.</h1>
				<div class="loader"></div>
				<div id="loadMessages">
					<h3>Waiting for client to run JavaScript...</h3>
				</div>
			</center>
		</div>
		<div id="login" style="display: none;">
			<h1 class="logintext">Login To CarOS</h1>
			<h3 id="attemptNumber">Login attempt: 1 of 7</h3>
			<center>
				<div id="login-video">
					<video autoplay id="loginvideo"></video>
					<canvas style="display: none" id="loginCanvas"></canvas>
					<center style="padding-bottom: 0px; padding-top: 0px;">
						<hr>
						<button class="sort" onclick="login.snapshot();">Take Photo</button>
						<button class="sort" onclick="if(login.usingVideo){login.transitionPasscode()}else{login.transitionVideo()}">Switch Login Method</button>
					</center>
				</div>
				<span id="login-passcodeField" style="font-size: large; text-decoration: underline"></span>
				<div id="login-passcode" style="display:none">
					<div>
						<button class="passcode" onclick="login.passcodeTracker+='1'; login.passcodeUpdate();">1</button>
						<button class="passcode" onclick="login.passcodeTracker+='2'; login.passcodeUpdate();">2</button>
						<button class="passcode" onclick="login.passcodeTracker+='3'; login.passcodeUpdate();">3</button>
						<button class="passcode" onclick="login.passcodeTracker+='4'; login.passcodeUpdate();">4</button>
						<button class="passcode" onclick="login.passcodeTracker+='5'; login.passcodeUpdate();">5</button>
						<button class="passcode" onclick="login.passcodeTracker+='6'; login.passcodeUpdate();">6</button>
						<button class="passcode" onclick="login.passcodeTracker+='7'; login.passcodeUpdate();">7</button>
						<button class="passcode" onclick="login.passcodeTracker+='8'; login.passcodeUpdate();">8</button>
						<button class="passcode" onclick="login.passcodeTracker+='9'; login.passcodeUpdate();">9</button>
					</div>
					<br>
					<div>
						<button class="sort" onclick="login.passcodeTracker = ' '; login.passcodeUpdate();">Clear</button>
						<button class="sort" onclick="login.passcode(login.passcodeTracker);">Submit</button>
						<hr>
						<button class="sort" onclick="if(login.usingVideo){login.transitionPasscode()}else{login.transitionVideo()}">Switch Login Method</button>
					</div>
				</div>
			</center>
		</div>
		<script>
			var socket = io();

			var reloadPage = false;

			//SET UP SOCKET LISTENERS
			socket.emit('initweb', { data: 'ready' });
			var socketListener = new utils.socketListener(socket,"POST");
			console.log("Sent ready socket"); //proper grammar lol

			socket.on('connect', function (data) {
				console.log("Connected to node.js backend");
				if (globals.disconnected && reloadPage) {
					console.log("Reloading in 5000ms due to reconnection");
					setTimeout(function(){
						window.location.reload();
					},5000);
				}
				login.readySteps.nodeConnected = true;
				globals.runtimeInformation.nodeConnected = true;
			});

			socket.on('webdata', function (data) {
				console.log("Python script connected!");
				login.readySteps.pythonConnected = true;
				globals.runtimeInformation.pythonConnected = true;
				console.log("Authkey: "+data.authkey);
				console.log("Runtime Info: "+JSON.stringify(data.runtimeInformation));
				if (typeof data.authkey == "undefined" || data.authkey == "undefined") {
					console.log("Authkey undefined, not changing");
				} else {
					globals.authkey = data.authkey;
					login.readySteps.validAuthkey = true;
					login.initializeOnceAuthkeyValid();
				}
				if (typeof data.runtimeInformation == "undefined" || data.runtimeInformation == "undefined") {
					console.error("RuntimeInformation recieved from server is undefined, what happened?");
				} else {
					var keys = Object.keys(data.runtimeInformation);
					for (var i=0; i<keys.length; i++) {
						//console.log("glob rti",globals.runtimeInformation,"dat rti",data.runtimeInformation)
						globals.runtimeInformation[keys[i]] = data.runtimeInformation[keys[i]];
					}
					login.readySteps.runtimeInformationProvided = true;
				}
			});

			socket.on('webready', function (data) {
				console.log("webready recieved from python initialization")
				socket.emit('webok', {data: "ok"});
			});

			socket.on('disconnect', function (data) {
				globals.disconnected = true;
				console.log("nodejs disconnect");
				login.readySteps.nodeConnected = false;
				globals.runtimeInformation.nodeConnected = false;
			});

			socketListener.addPersistentListener("runtimeInformation", function(data) {
			    console.log("RuntimeInfo: ",data.information);
			    var keys = Object.keys(data.information); //only override keys from jsondat
			    for (var i=0; i<keys.length; i++) {
			        globals.runtimeInformation[keys[i]] = data.information[keys[i]];
			    }
			    try {
				    clearTimeout(globals.runtimeInfoUpdateTimeout);
				} catch(e) {
				    console.error("Error clearing global runtime info update timeout")
				}
				if (typeof globals.runtimeInformation.heartbeatMS == "undefined") {
				    console.warn("HeartbeatMS not defined in globals; not setting timeout");
				} else {
				    console.log("[HB] set heartbeat timeout: "+globals.runtimeInformation.heartbeatMS);
				    globals.runtimeInfoUpdateTimeout = setTimeout(function(){
				        console.log("[HB] Heartbeat request runtimeinfo");
				        globals.updateRuntimeInformation();
				    },globals.runtimeInformation.heartbeatMS);
				}
				if (typeof globals.runtimeInformation.outsideTemp == "undefined") {
					console.warn("OutsideTemp not defined in globals; not setting dashboard extTemp");
				} else {
					ID("extTemp").innerHTML = "EXT: "+globals.runtimeInformation.outsideTemp+"°F";
				}
				if (typeof globals.runtimeInformation.insideTemp == "undefined") {
					console.warn("InsideTemp not defined in globals; not setting dashboard intTemp");
				} else {
					ID("intTemp").innerHTML = "INT: "+globals.runtimeInformation.insideTemp+"°F";
				}
			});

			socketListener.addPersistentListener("login-opencvqueue", function(data) {
				globals.openCVQueue.push(String(data.queue));
				console.log("opencvqueue recv "+data.queue);
			});

			socketListener.addPersistentListener('login-opencvdata', function(data) {
				var canvas = ID("loginCanvas");
				canvas.style.display = "block";
				var ctx = canvas.getContext('2d');
				var buffer = data.buffer;
				var queue = data.queue;
				var labels = data.labels;
				var confidences = data.confidences;
				var rects = data.rects;
				var approved = data.approved;
				var attempt = data.attemptNumber;
				var totalAttempts = data.totalAttempts;
				console.log("opencv pic queue: "+queue);
				console.log("ihavequeues: "+JSON.stringify(globals.openCVQueue));
				console.log("rects: "+JSON.stringify(rects)+"\nconfidences: "+JSON.stringify(confidences)+"\nlabels: "+JSON.stringify(labels)+"\napproved: "+approved);
				console.log("recieved opencv buffer");
				//console.log(buffer);
				if (globals.openCVQueue.indexOf(String(queue)) !== -1) {
					globals.openCVQueue.splice(globals.openCVQueue.indexOf(String(queue)),1); //remove from opencvqueue list
					var img = new Image();
					img.src = 'data:image/jpg;base64,' + buffer;
					img.onload = function(){
						console.log("onload img");
						ctx.drawImage(this, 0, 0);
					}
					if (approved) {
						login.approvedLogin();
					} else {
						canvas.style.display = "none";
						ID("attemptNumber").innerHTML = "Login attempt: "+attempt+" of "+totalAttempts;
					}
	  			} else {
	  				console.log("ignoring because client doesn't have queue")
	  			}
			});

			socketListener.addPersistentListener("processingError", function (data) {
				console.error("Error from nodejs: '"+data.error+"'");
				bootbox.alert("Server Error: "+data.error);
			});

			socketListener.addPersistentListener("login-passcodeapproval", function(data) {
				if (data.approved == true) {
					login.approvedLogin();
				}
			})

			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
			navigator.mediaDevices.getUserMedia({video: true}).then(function(localMediaStream) {
				globals.loginVideoStream = localMediaStream;
				globals.loginVideo = ID("loginvideo");
				globals.loginVideo.srcObject = localMediaStream;
				// Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
				// See crbug.com/110938.
				globals.loginVideo.onloadedmetadata = function(e) {
					console.log("Meta data for loginVideo loaded")
				  //globals.loginVideo.snapshot();
				};
				globals.loginVideo.oncanplaythrough = function(e) {
					console.log("Video loaded; sending snapshot")
					setTimeout(function(){
						login.readySteps.videoLoad = true;
					},500); //give some time for camera to adjust
				};
				console.log("lms: ",localMediaStream)
			}).catch(function(e){
				console.error("Error getting usermedia for login video, e="+JSON.stringify(e))
			});

			if (typeof annyang !== "undefined") {
				annyang.debug(true);
				/*annyang.addCommands({
					':data': function(data) {
						globals.voice.onSpeech(data);
					}
				});*/
				annyang.addCallback('error', function(e) {
					console.error("Error with annyang: "+JSON.stringify(e));
				});
				annyang.addCallback('errorNetwork', function() {
					console.error("Error with annyang connecting to internet");
				});
				annyang.addCallback('errorPermissionBlocked', function() {
					console.error("Error with annyang permission blocked");
				});
				annyang.addCallback('errorPermissionDenied', function() {
					console.error("Error with annyang permission denied");
				});

				annyang.addCallback('result', function(data) {
					console.log("result: "+JSON.stringify(data));
					/*if (SpeechKITT.isListening()) {
						SpeechKITT.toggleRecognition(); //disable speechKitt
					}*/
					globals.voice.onSpeech(data);
				});
				if (typeof SpeechKITT !== "undefined") {
					// Tell KITT to use annyang
					SpeechKITT.annyang();

					// Define a stylesheet for KITT to use
					SpeechKITT.setStylesheet('js/speechkittthemes/flat.css');
					SpeechKITT.displayRecognizedSentence(false); //broken so implemented my own
				} else {
					console.error("SpeechKITT not defined; annyang is active however");
				}
			} else {
				console.error("Annyang is not defined; was it included in the source code?");
			}

			socketListener.addPersistentListener("speechMatchingResult", function(data) {
				console.log("recieved speech matching result: "+JSON.stringify(data));
				if (data.response == "" || data.response == " ") {
					data.response = "I'm sorry, I didn't quite catch that. Try again.";
				}
				var skittLT = document.getElementById("skitt-listening-text");
				globals.voice.speaker(data.response, function(){
					setTimeout(function(){
						if (typeof skittLT == "undefined" || skittLT == null) {
							console.error("Couldn't locate SKitt text on speech");
						} else {
							skittLT.innerHTML = globals.voice.defaultInstructions;
						}
					},globals.voice.defaultTextDelay);
				});
				if (typeof skittLT == "undefined" || skittLT == null) {
					console.error("Couldn't locate SKitt text on speech");
				} else {
					skittLT.innerHTML = data.response;
				}
			});

			//login.initialize() //init because im on a plane and at bottom because it shouldnt interfere

		</script>
		<!--Google maps script-->
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArwv2IQ00_3Z8_VQUwB1C9cJr0cujUnLk&callback=login.initialize"></script>
	</body>
</html>