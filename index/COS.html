<!DOCTYPE HTML>
<html> <!-- manifest="data.appcache" -->
	<head>
		<title>C.OS. V1</title>
		<script src="js/socket.io.js"></script>
		<script src="js/helpLib.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/mapImageOverlay.js"></script>
		<script src="js/speaker.js"></script>
		<script src="js/annyang.js"></script>
		<script src="js/speechkitt.min.js"></script>
		<link rel="stylesheet" type="text/css" media="screen" href="css/style.css">
	</head>
	<body>
		<div id="main" class="mapWrapper" style="display: none;">
			<ul class="menutop">
				<li><h1>Welcome to CarOS</h1></li>
				<li class="menubreaker">|</li>
				<li><h1>App</h1></li>
				<li class="menubreaker">|</li>
				<li><h1>App2</h1></li>
				<li class="menubreaker">|</li>
				<li><h1>App3</h1></li>
				<li class="menubreaker">|</li>
				<li><h1>App4</h1></li>
				<li class="menubreaker">|</li>
				<li><h1>App5</h1></li>
				<li class="menubreaker">|&nbsp;&nbsp;&nbsp;</li>
				<li class="menuitemnoanim"><p id="time" style="min-width: 150px !important; font-size: 32px;">12:00 AM</p></li> <!-- Does min-width even work? Fix for tmrw-->
				<li class="menubreaker">&nbsp;</li>
				<li class="menuitemnoanim"><img src="images/wifi0.png" width="50" height="25" id="wifilevel"></img></li>
			</ul>
			<div id="mainMap" class="fullScreenMap"></div>
			<ul class="menubottom">
				<li><h1>Welcome to CarOS V1!</h1></li>
				<li class="menuitemnoanim">|</li>
				<li><input id="pygame"></input></li>
			</ul>
		</div>
		<div class="inforight" id="inforight">
			<pre id="connectpy">Are you connected to python backend: No</pre>
			<pre id="connectnode">Are you connected to node backend: No</pre>
			<pre id="info">Info: </pre>
		</div>
		<div id="loading">
			<center>
				<h1>Connected to server.</h1>
				<div class="loader"></div>
				<div id="loadMessages">
					<h3>Waiting for client to run JavaScript...</h3>
				</div>
			</center>
		</div>
		<div id="login" style="display: none;">
			<h1 class="logintext">Login To CarOS</h1>
			<h3 id="attemptNumber">Login attempt: 1 of 7</h3>
			<center>
				<div id="login-video">
					<video autoplay id="loginvideo"></video>
					<canvas style="display: none" id="loginCanvas"></canvas>
					<center style="padding-bottom: 0px; padding-top: 0px;">
						<hr>
						<button class="sort" onclick="login.snapshot();">Take Photo</button>
						<button class="sort" onclick="if(login.usingVideo){login.transitionPasscode()}else{login.transitionVideo()}">Switch Login Method</button>
					</center>
				</div>
				<span id="login-passcodeField" style="font-size: large; text-decoration: underline"></span>
				<div id="login-passcode" style="display:none">
					<div>
						<button class="passcode" onclick="login.passcodeTracker+='1'; login.passcodeUpdate();">1</button>
						<button class="passcode" onclick="login.passcodeTracker+='2'; login.passcodeUpdate();">2</button>
						<button class="passcode" onclick="login.passcodeTracker+='3'; login.passcodeUpdate();">3</button>
						<button class="passcode" onclick="login.passcodeTracker+='4'; login.passcodeUpdate();">4</button>
						<button class="passcode" onclick="login.passcodeTracker+='5'; login.passcodeUpdate();">5</button>
						<button class="passcode" onclick="login.passcodeTracker+='6'; login.passcodeUpdate();">6</button>
						<button class="passcode" onclick="login.passcodeTracker+='7'; login.passcodeUpdate();">7</button>
						<button class="passcode" onclick="login.passcodeTracker+='8'; login.passcodeUpdate();">8</button>
						<button class="passcode" onclick="login.passcodeTracker+='9'; login.passcodeUpdate();">9</button>
					</div>
					<br>
					<div>
						<button class="sort" onclick="login.passcodeTracker = ' '; login.passcodeUpdate();">Clear</button>
						<button class="sort" onclick="login.passcode(login.passcodeTracker);">Submit</button>
					</div>
				</div>
			</center>
		</div>
		<script>
			var socket = io();
			//GLOBAL VARIABLES
			var globals = {
				disconnected: false,
				authkey: "waiting",
				openCVQueue: [],
				loginVideo: ID("loginvideo"),
				loginVideoStream: undefined,
				fadeInOutDelay: 200,
				map: {
					mapReference: "uninit",
					defaultZoom: 15,
					defaultMapGestureHandling: "greedy",
					geolocationOptions: {
						enableHighAccuracy: true,
						timeout: 60000,
						maximumAge: 0,
						desiredAccuracy: 0,
						frequency: 1
					},
					markers: [],
					locations: {
						burlingame: {
							lat: 37.577870,
							lng: -122.34809
						}
					},
					grayScaleEnabled: false,
					createMarker: function(opts, callback) {
						if (typeof opts == "undefined" || typeof callback == "undefined") {
							console.error("[MAPS] Opts or callback undefined");
						} else {
							var marker = new google.maps.Marker(opts);
							google.maps.event.addListener(marker, 'click', function(){
								try {
									callback();
								} catch(e) {
									console.error("[MAPS] Error running callback function")
								}
							})
							globals.map.markers.push(marker);
							return marker;
						}
						return "error";
					},
					currentPos: {
						lat: 37.577870,
						lng: -122.34809
					},
					getClientLocation: function() {
						if (navigator.geolocation) {
							navigator.geolocation.getCurrentPosition(function(position) {
								var la = position.coords.latitude;
								var ln = position.coords.longitude;
								console.log("[MAPS] got lat nowatch: "+la+", lng: "+ln);
								globals.map.currentPos.lat = la;
								globals.map.currentPos.lng = ln;
							}, function(){
								console.error("[MAPS] Error getting user position noClientWatch. Code: "+error.code+", message: "+error.message);
							}, globals.map.geolocationOptions);
						} else {
							console.error("[MAPS] Client browser does not support geolocation.");
						}
					},
					watchID: null,
					setupClientWatch: function(callback) {
						if (navigator.geolocation) {
							if (globals.map.watchID != null) {
					            navigator.geolocation.clearWatch(watchID);
					            globals.map.watchID = null;
					        }
							globals.map.watchID = navigator.geolocation.watchPosition(function(position) {
								var la = position.coords.latitude;
								var ln = position.coords.longitude;
								console.log("[MAPS] got lat from watch: "+la+", lng: "+ln);
								globals.map.currentPos.lat = la;
								globals.map.currentPos.lng = ln;
								try {
									callback(la, ln);
								} catch(e) {
									console.error("[MAPS] failed to run lat watch callback function")
								}
							}, function(){
								console.error("[MAPS] Error getting user position clientWatch.");
							}, globals.map.geolocationOptions);
						} else {
							console.error("[MAPS] Client browser does not support geolocation.");
						}
					},
					defaultCarImagePath: "images/carinverted.png",
					defaultCarImageWidth: 100, //used to be 50
					defaultCarImageHeight: 33.125, //used to be 50
					getImageBounds: function(path, callback) {
						var imgLoader = new Image();

						imgLoader.onload = function() {
						    var height = imgLoader.height;
						    var width = imgLoader.width;
						    try {
						    	callback(width, height);
						    } catch(e) {
						    	console.error("[MAPS] Error running callback for getImageBounds");
						    }
						}
						imgLoader.src = path;
					},
					latLngToPixels: function(lat, lng, map) {
						var latLng = new google.maps.LatLng(lat, lng);
						var projection = map.getProjection();
						var bounds = map.getBounds();
						var topRight = projection.fromLatLngToPoint(bounds.getNorthEast());
						var bottomLeft = projection.fromLatLngToPoint(bounds.getSouthWest());
						var scale = Math.pow(2, map.getZoom());
						var worldPoint = projection.fromLatLngToPoint(latLng);
						return [Math.floor((worldPoint.x - bottomLeft.x) * scale), Math.floor((worldPoint.y - topRight.y) * scale)];
					},
					shrinkViewportPercentage: 0.48,
					fitMapToMarkers: function(markers, map) { //ty https://stackoverflow.com/questions/8170023/google-maps-api-3-zooms-out-on-fitbounds
						var bounds = new google.maps.LatLngBounds();
						for (var i = 0; i < markers.length; i++) {
							bounds.extend(new google.maps.LatLng(markers[i].position.lat(), markers[i].position.lng()));
						}
						//map.setCenter(bounds.getCenter());
						var sw = bounds.getSouthWest();
						var ne = bounds.getNorthEast();

						var latAdj = Math.abs(ne.lat() - sw.lat()) * globals.map.shrinkViewportPercentage;
						var lngAdj = Math.abs(ne.lng() - sw.lng()) * globals.map.shrinkViewportPercentage;

						var latLngBounds = [
							{lat: sw.lat() + latAdj, lng: sw.lng() + lngAdj},
							{lat: ne.lat() - latAdj, lng: ne.lng() - lngAdj}
						]

						var newBounds = new google.maps.LatLngBounds(latLngBounds[0], latLngBounds[1]);

						map.fitBounds(newBounds);
						map.panToBounds(newBounds);

						if (map.getZoom() < 4) {
							map.setZoom(4);
						}
					}, //todo make this function run whenever the user is not touching the screen
					steeringWheelMarker: ""
				},
				voice: {
					speaker: Speech.speak,
					onSpeech: function(data) {
						//console.log("recieved speech data: "+data);
						socket.emit("GET",{action: "processSpeech", authkey: globals.authkey, speech: data});
					},
					defaultInstructions: "What can I help you with?",
					defaultTextDelay: 1000
				}
			}

/*voices:
	samantha
	tessa
	yuri
	google uk english male
	google us english
*/
			globals.loginVideo.snapshot = function() {
				var canvas = ID("loginCanvas");
  				var ctx = canvas.getContext('2d');
  				canvas.height = globals.loginVideo.videoHeight;
  				canvas.width = globals.loginVideo.videoWidth;
  				ctx.drawImage(globals.loginVideo, 0, 0);
  				var daturl = canvas.toDataURL('image/png');
  				/*var raw = datatoraw(daturl);
  				var blob = raw.blob;
  				var rawdata = raw.rawarr;*/
  				socket.emit("GET",{action: "login-imageready", raw: daturl, authkey: globals.authkey});//blob: blob, raw: rawdata});

			}

			//LOGIN SETUP SCRIPTS
			var login = {
				snapshot: globals.loginVideo.snapshot,
				passcode: function(psc) {
					console.log("psc submit "+psc);
					socket.emit("GET",{action: "login-passcodeready", authkey: globals.authkey, passcode: psc.trim()});
				},
				usingVideo: true,
				passcodeTracker: " ",
				approvedLogin: function(){
					ID("login").className += " fadeout";
					globals.loginVideoStream.getTracks()[0].stop();
					ID("main").className += " fadein";
					// Render KITT's interface
					SpeechKITT.render();
					setTimeout(function(){
						ID("login").style.display = "none";
					},globals.fadeInOutDelay);
				},
				transitionPasscode: function(){
					login.usingVideo = false;
					ID("login-passcode").style.display = "block";
					ID("login-video").className = "fadeout";
					ID("login-passcode").className = "fadein";
					setTimeout(function(){
						ID("login-video").style.display = "none";
					},globals.fadeInOutDelay);
				},
				transitionVideo: function(){
					login.usingVideo = true;
					ID("login-video").style.display = "block";
					ID("login-video").className = "fadein";
					ID("login-passcode").className = "fadeout";
					setTimeout(function(){
						ID("login-passcode").style.display = "none";
					},globals.fadeInOutDelay);
				},
				pageReady: function(){
					globals.loginVideo.snapshot();
					ID("loading").style.display = "none";
					ID("login").style.display = "block";
					ID("loginvideo").style.display = "block";
				},
				readySteps: {
					pageLoad: true,
					videoLoad: false,
					nodeConnected: false,
					pythonConnected: false,
					validAuthkey: false,
					internetConnected: false
				},
				loadedOnce: false,
				readyUpdater: setInterval(function(){
					var loadMessages = ID("loadMessages");
					var keys = Object.keys(login.readySteps);
					if (login.loadedOnce == false) {
						login.loadedOnce = true;
						login.previousReadySteps = JSON.parse(JSON.stringify(login.readySteps));
						loadMessages.innerHTML = "<h2 style='text-decoration: underline'>Loading Scripts</h2>";
						for (var i=0; i<keys.length; i++) {
							var title = document.createElement("h3"); //create h3 tag
							title.setAttribute("style","display: inline;");
							var text = document.createTextNode(keys[i]+": ");
							title.appendChild(text);

							var img = document.createElement("img"); //create image element
							img.setAttribute("width",String(login.imageWidth)+"px");
							img.setAttribute("height",String(login.imageHeight)+"px");
							img.setAttribute("id","loadImg"+keys[i])
							if (login.readySteps[keys[i]]) { //dynamically add check or noncheck
								img.setAttribute("src",login.imageCheckPath);
							} else {
								img.setAttribute("src",login.imageNoCheckPath);
							}

							var br = document.createElement("br");
							var br2 = document.createElement("br");

							loadMessages.appendChild(title);
							loadMessages.appendChild(img);
							loadMessages.appendChild(br);
							loadMessages.appendChild(br2);
						}
					} else {
						var ready = true;
						for (var i=0; i<keys.length; i++) {
							if (!login.readySteps[keys[i]]) {
								ready = false;
							}
							if (login.previousReadySteps[keys[i]] !== login.readySteps[keys[i]]) {
								var img = ID("loadImg"+keys[i]);
								if (login.readySteps[keys[i]]) { //dynamically add check or noncheck
									img.setAttribute("src",login.imageCheckPath);
								} else {
									img.setAttribute("src",login.imageNoCheckPath);
								}
							}
						}
						login.previousReadySteps = JSON.parse(JSON.stringify(login.readySteps));
						if (ready) {
							login.pageReady();
							clearInterval(login.readyUpdater);
						}
					}
				},200),
				imageCheckPath: "images/check.png",
				imageNoCheckPath: "images/nocheck.png",
				imageWidth: 16,
				imageHeight: 16,
				passcodeUpdate: function(){
					ID("login-passcodeField").innerHTML = login.passcodeTracker;
				},
				initializeMap: function(){
					login.readySteps.internetConnected = true;
					globals.map.mapReference = new google.maps.Map(ID('mainMap'), { //setup map
						zoom: globals.map.defaultZoom,
						center: globals.map.locations.burlingame,
						gestureHandling: globals.map.defaultMapGestureHandling,
						styles: (globals.map.grayScaleEnabled)?[{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]/**/},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"on"}]/**/},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffff00"},{lightness:-25},{saturation:-97}]}]:[],
						mapTypeId: 'hybrid'
					});

					globals.map.createMarker({ //create burlingame marker
						position: globals.map.locations.burlingame,
						map: globals.map.mapReference,
						clickable: true,
						title: 'Burlingame, CA'
					},function(){
						console.log("clicked marker");
					});

					/*var imageBounds = globals.map.getImageBounds(globals.map.defaultImagePath, function(width, height) { //get imagebounds for steering wheel and place it on map
						console.log("got imagebounds: w="+width+", h="+height);
						var lat = globals.map.currentPos.lat;
						var lng = globals.map.currentPos.lng;

						var currentPixels = globals.map.latLngToPixels(lat, lng, globals.map.mapReference);

						var boundsInPixels = [
							[currentPixels[0], currentPixels[1]],
							[currentPixels[0]+width, currentPixels[1]+height];
						];

						var currentBounds = glob

						globals.map.mapOverlay = new MapImageOverlay(imageBounds, globals.map.defaultImagePath, globals.map.mapReference);
					});*/

					var steeringWheelIcon = {
						url: globals.map.defaultCarImagePath,
						scaledSize: new google.maps.Size(globals.map.defaultCarImageWidth,globals.map.defaultCarImageHeight),
						origin: new google.maps.Point(0,0),
						anchor: new google.maps.Point(globals.map.defaultCarImageWidth/2,globals.map.defaultCarImageHeight/2)
					}
					globals.map.steeringWheelMarker = globals.map.createMarker({
						position: globals.map.locations.burlingame,
						map: globals.map.mapReference,
						clickable: true,
						draggable: true,
						icon: steeringWheelIcon
					}, function(){
						console.log("Clicking other marker")
					});

					globals.map.setupClientWatch(function(lat, lng) {
						globals.map.steeringWheelMarker.setPosition(new google.maps.LatLng(lat, lng));
						globals.map.fitMapToMarkers(globals.map.markers, globals.map.mapReference);
					});
				}
			}

			setInterval(function(){ //validate key listener
				socket.emit('GET', {action: "validatekey", authkey: globals.authkey})
				socketListener.addListener("validatekey",function (data){
					console.log("Authkey valid?: "+data.valid);
					if (data.valid == "false" && globals.authkey != "") {
						console.error("Authkey invalid");
						/*if (confirm("Authkey has expired. Reload page?")) {
							window.location.reload();
						}*/
						window.location.reload();
					} else if (data.valid == "false") {
						console.log("Still waiting on python for valid authkey, not prompting user");
						//alert("Python is not initialized, waiting for authkey from server...")
					}
				})
			}, 25000);
			setTimeout(function(){login.approvedLogin()},2000);


			//SET UP SOCKET LISTENERS
			socket.emit('initweb', { data: 'ready' });
			var socketListener = new utils.socketListener(socket,"POST");
			console.log("Sent ready socket"); //proper grammar lol
			socket.on('connect', function (data) {
				ID('connectnode').innerHTML = "Are you connected to node backend: Yes";
				console.log("Connected to node.js backend");
				if (globals.disconnected) {
					console.log("Reloading in 5000ms due to reconnection");
					setTimeout(function(){
						window.location.reload();
					},5000);
				}
				login.readySteps.nodeConnected = true;
			});

			socket.on('webdata', function (data) {
				console.log("Python script connected!");
				login.readySteps.pythonConnected = true;
				console.log("Authkey: "+data.authkey);
				if (typeof data.authkey == "undefined" || data.authkey == "undefined") {
					console.log("Authkey undefined, not changing");
				} else {
					globals.authkey = data.authkey;
					login.readySteps.validAuthkey = true;
				}
				ID("pygame").onkeyup = function() {
					console.log("keyup elem");
					socket.emit('GET', {action: "pydata", authkey: globals.authkey, data: ID("pygame").value})
				}
				ID('connectpy').innerHTML = "Are you connected to python backend: Yes";
			});

			socket.on('webready', function (data) {
				console.log("webready recieved from python initialization")
				socket.emit('webok', {data: "ok"});
			});

			socket.on('pydisconnect', function (data) {
				ID('connectpy').innerHTML = "Are you connected to python backend: No";
				console.log("Python disconnect");
				login.readySteps.pythonConnected = false;
			});

			socket.on('disconnect', function (data) {
				ID('connectnode').innerHTML = "Are you connected to node backend: No";
				globals.disconnected = true;
				console.log("nodejs disconnect");
				login.readySteps.nodeConnected = false;
			});

			socketListener.addPersistentListener("login-opencvqueue", function(data) {
				globals.openCVQueue.push(String(data.queue));
				console.log("opencvqueue recv "+data.queue);
			});

			socketListener.addPersistentListener('login-opencvdata', function(data) {
				var canvas = ID("loginCanvas");
				canvas.style.display = "block";
				var ctx = canvas.getContext('2d');
				var buffer = data.buffer;
				var queue = data.queue;
				var labels = data.labels;
				var confidences = data.confidences;
				var rects = data.rects;
				var approved = data.approved;
				var attempt = data.attemptNumber;
				var totalAttempts = data.totalAttempts;
				console.log("opencv pic queue: "+queue);
				console.log("ihavequeues: "+JSON.stringify(globals.openCVQueue));
				console.log("rects: "+JSON.stringify(rects)+"\nconfidences: "+JSON.stringify(confidences)+"\nlabels: "+JSON.stringify(labels)+"\napproved: "+approved);
				console.log("recieved opencv buffer");
				//console.log(buffer);
				if (globals.openCVQueue.indexOf(String(queue)) !== -1) {
					globals.openCVQueue.splice(globals.openCVQueue.indexOf(String(queue)),1); //remove from opencvqueue list
					var img = new Image();
					img.src = 'data:image/jpg;base64,' + buffer;
					img.onload = function(){
						console.log("onload img");
						ctx.drawImage(this, 0, 0);
					}
					if (approved) {
						login.approvedLogin();
					} else {
						canvas.style.display = "none";
						ID("attemptNumber").innerHTML = "Login attempt: "+attempt+" of "+totalAttempts;
					}
	  			} else {
	  				console.log("ignoring because idonthavequeue")
	  			}
			});

			socketListener.addPersistentListener("processingError", function (data) {
				console.error("Error from nodejs: '"+data.error+"'");
				ID("info").innerHTML = "Info: Processing Error '"+data.error+"'";
			});

			socketListener.addPersistentListener("login-passcodeapproval", function(data) {
				if (data.approved == true) {
					login.approvedLogin();
				}
			})

			navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
			navigator.getUserMedia({video: true}, function(localMediaStream) {
				globals.loginVideoStream = localMediaStream;
				globals.loginVideo.src = window.URL.createObjectURL(localMediaStream);
				console.log(localMediaStream,window.URL.createObjectURL(localMediaStream))
				// Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
				// See crbug.com/110938.
				globals.loginVideo.onloadedmetadata = function(e) {
					console.log("Meta data for loginVideo loaded")
				  //globals.loginVideo.snapshot();
				};
				globals.loginVideo.oncanplaythrough = function(e) {
					console.log("Video loaded; sending snapshot")
					setTimeout(function(){
						login.readySteps.videoLoad = true;
					},300); //give some time for camera to adjust
				};
			}, function(){
				console.log("error getting getusermedia")
			});

			if (typeof annyang !== "undefined") {
				annyang.debug(true);
				/*annyang.addCommands({
					':data': function(data) {
						globals.voice.onSpeech(data);
					}
				});*/
				annyang.addCallback('error', function(e) {
					console.error("Error with annyang: "+JSON.stringify(e));
				});
				annyang.addCallback('errorNetwork', function() {
					console.error("Error with annyang connecting to internet");
				});
				annyang.addCallback('errorPermissionBlocked', function() {
					console.error("Error with annyang permission blocked");
				});
				annyang.addCallback('errorPermissionDenied', function() {
					console.error("Error with annyang permission denied");
				});

				annyang.addCallback('result', function(data) {
					console.log("result: "+JSON.stringify(data));
					/*if (SpeechKITT.isListening()) {
						SpeechKITT.toggleRecognition(); //disable speechKitt
					}*/
					globals.voice.onSpeech(data);
				});
				if (typeof SpeechKITT !== "undefined") {
					// Tell KITT to use annyang
					SpeechKITT.annyang();

					// Define a stylesheet for KITT to use
					SpeechKITT.setStylesheet('js/speechkittthemes/flat.css');
					SpeechKITT.displayRecognizedSentence(false); //broken so implemented my own
				} else {
					console.error("SpeechKITT not defined; annyang is active however");
				}
				if (typeof Speech !== "undefined") {
					if (Speech.isSupported) {
						var voices = Speech.listVoices();
						if (typeof Speech.setVoice("Google UK English Male") == "undefined") {
							console.warn("Defaulting to first system voice.");
							if (typeof Speech.setVoice(voices[0].name) == "undefined") {
								console.warn("Failed to set speech voice, waiting for voices load...");
								Speech.voicesLoaded = function() {
									var voices = Speech.listVoices();
									if (typeof Speech.setVoice("Google UK English Male") == "undefined") {
										console.warn("Defaulting to first system voice.");
										if (typeof Speech.setVoice(voices[0].name) == "undefined") {
											console.warn("Failed to set speech voice.");
										}
									}
								}
							}
						}
					} else {
						console.error("Client is not capable of speech synthesis.")
					}
				} else {
					console.error("Speech not defined; annyang is active however")
				}
			} else {
				console.error("Annyang is not defined; was it included in the source code?");
			}

			socketListener.addPersistentListener("speechMatchingResult", function(data) {
				console.log("recieved speech matching result: "+JSON.stringify(data));
				if (data.response == "" || data.response == " ") {
					data.response = "I'm sorry, I didn't quite catch that. Try again.";
				}
				var skittLT = document.getElementById("skitt-listening-text");
				globals.voice.speaker(data.response, function(){
					setTimeout(function(){
						if (typeof skittLT == "undefined" || skittLT == null) {
							console.error("Couldn't locate SKitt text on speech");
						} else {
							skittLT.innerHTML = globals.voice.defaultInstructions;
						}
					},globals.voice.defaultTextDelay);
				});
				if (typeof skittLT == "undefined" || skittLT == null) {
					console.error("Couldn't locate SKitt text on speech");
				} else {
					skittLT.innerHTML = data.response;
				}
			});

		</script>
		<!--Google maps script-->
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArwv2IQ00_3Z8_VQUwB1C9cJr0cujUnLk&callback=login.initializeMap"></script>
	</body>
</html>