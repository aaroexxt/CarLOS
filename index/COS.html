<!DOCTYPE HTML>
<html> <!-- manifest="data.appcache" -->
	<head>
		<title>C.OS. V1</title>
		<script src="js/socket.io.js"></script>
		<script src="js/helpLib.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/mapImageOverlay.js"></script>
		<script src="js/speaker.js"></script>
		<script src="js/annyang.js"></script>
		<script src="js/globals.js"></script>
		<script src="js/speechkitt.min.js"></script>
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/bootbox.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" media="screen" href="css/style.css">
		<link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css">
		<meta charset="UTF-8">
	</head>
	<body>
		<div id="main" class="mapWrapper" style="display: none;">
			<ul class="menutop" style="transform: translateX(-12px)">
				<li>Welcome to CarOS</li>
				<li class="menubreaker">|</li>
				<li><img src="images/music.png" width="25" height="25" class="circle"></img></li>
				<li class="menubreaker">|</li>
				<li>App2</li>
				<li class="menubreaker">|</li>
				<li><img src="images/a.png" width="40" height="40" onclick="globals.MainPopup.displayMain();"></img></li>
				<li class="menubreaker">|</li>
				<li>App4</li>
				<li class="menubreaker">|</li>
				<li>App5</li>
				<li class="menubreaker">|&nbsp;&nbsp;&nbsp;</li>
				<li class="menuitemnoanim"><p id="time" style="min-width: 150px !important; font-size: 17px; font-family: 'Helvetica Neue';">12:00 AM</p></li> <!-- Does min-width even work? Fix for tmrw-->
				<li class="menubreaker">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
				<li class="menuitemnoanim"><img src="images/wifi0.png" width="75" height="30" style="padding-top: 5px; padding-bottom: 3px;" id="wifilevel"></img></li>
				<li class="menuitemnoanim"><p id="wifispeed" style="min-width: 150px !important; font-size: 17px; font-family: 'Helvetica Neue'; padding-left: 0px; padding-right: 0px;">1 MB/S</p></li>
			</ul>
			<div id="mainMap" class="fullScreenMap"></div>
			<ul class="menubottom">
				<li><h1>Welcome to CarOS V1!</h1></li>
				<li class="menuitemnoanim">|</li>
				<li><input id="pygame"></input></li>
			</ul>
		</div>
		<div id="loading">
			<center>
				<h1>Connected to server.</h1>
				<div class="loader"></div>
				<div id="loadMessages">
					<h3>Waiting for client to run JavaScript...</h3>
				</div>
			</center>
		</div>
		<div id="login" style="display: none;">
			<h1 class="logintext">Login To CarOS</h1>
			<h3 id="attemptNumber">Login attempt: 1 of 7</h3>
			<center>
				<div id="login-video">
					<video autoplay id="loginvideo"></video>
					<canvas style="display: none" id="loginCanvas"></canvas>
					<center style="padding-bottom: 0px; padding-top: 0px;">
						<hr>
						<button class="sort" onclick="login.snapshot();">Take Photo</button>
						<button class="sort" onclick="if(login.usingVideo){login.transitionPasscode()}else{login.transitionVideo()}">Switch Login Method</button>
					</center>
				</div>
				<span id="login-passcodeField" style="font-size: large; text-decoration: underline"></span>
				<div id="login-passcode" style="display:none">
					<div>
						<button class="passcode" onclick="login.passcodeTracker+='1'; login.passcodeUpdate();">1</button>
						<button class="passcode" onclick="login.passcodeTracker+='2'; login.passcodeUpdate();">2</button>
						<button class="passcode" onclick="login.passcodeTracker+='3'; login.passcodeUpdate();">3</button>
						<button class="passcode" onclick="login.passcodeTracker+='4'; login.passcodeUpdate();">4</button>
						<button class="passcode" onclick="login.passcodeTracker+='5'; login.passcodeUpdate();">5</button>
						<button class="passcode" onclick="login.passcodeTracker+='6'; login.passcodeUpdate();">6</button>
						<button class="passcode" onclick="login.passcodeTracker+='7'; login.passcodeUpdate();">7</button>
						<button class="passcode" onclick="login.passcodeTracker+='8'; login.passcodeUpdate();">8</button>
						<button class="passcode" onclick="login.passcodeTracker+='9'; login.passcodeUpdate();">9</button>
					</div>
					<br>
					<div>
						<button class="sort" onclick="login.passcodeTracker = ' '; login.passcodeUpdate();">Clear</button>
						<button class="sort" onclick="login.passcode(login.passcodeTracker);">Submit</button>
						<hr>
						<button class="sort" onclick="if(login.usingVideo){login.transitionPasscode()}else{login.transitionVideo()}">Switch Login Method</button>
					</div>
				</div>
			</center>
		</div>
		<script>
		setTimeout(function(){login.approvedLogin()},1500);
			var socket = io();

			//SET UP SOCKET LISTENERS
			socket.emit('initweb', { data: 'ready' });
			var socketListener = new utils.socketListener(socket,"POST");
			console.log("Sent ready socket"); //proper grammar lol

			socket.on('connect', function (data) {
				console.log("Connected to node.js backend");
				if (globals.disconnected) {
					console.log("Reloading in 5000ms due to reconnection");
					setTimeout(function(){
						window.location.reload();
					},5000);
				}
				login.readySteps.nodeConnected = true;
				globals.runtimeInformation.nodeConnected = true;
			});

			socket.on('webdata', function (data) {
				console.log("Python script connected!");
				login.readySteps.pythonConnected = true;
				globals.runtimeInformation.pythonConnected = true;
				console.log("Authkey: "+data.authkey);
				console.log("Runtime Info: "+JSON.stringify(data.runtimeInformation));
				if (typeof data.authkey == "undefined" || data.authkey == "undefined") {
					console.log("Authkey undefined, not changing");
				} else {
					globals.authkey = data.authkey;
					login.readySteps.validAuthkey = true;
				}
				if (typeof data.runtimeInformation == "undefined" || data.runtimeInformation == "undefined") {
					console.error("RuntimeInformation recieved from server is undefined, what happened?");
				} else {
					var keys = Object.keys(data.runtimeInformation);
					for (var i=0; i<keys.length; i++) {
						//console.log("glob rti",globals.runtimeInformation,"dat rti",data.runtimeInformation)
						globals.runtimeInformation[keys[i]] = data.runtimeInformation[keys[i]];
					}
					login.readySteps.runtimeInformationProvided = true;
				}
				ID("pygame").onkeyup = function() {
					console.log("keyup elem");
					socket.emit('GET', {action: "pydata", authkey: globals.authkey, data: ID("pygame").value})
				}
			});

			socket.on('webready', function (data) {
				console.log("webready recieved from python initialization")
				socket.emit('webok', {data: "ok"});
			});

			socket.on('pydisconnect', function (data) {
				console.log("Python disconnect");
				login.readySteps.pythonConnected = false;
				globals.runtimeInformation.pythonConnected = false;
			});

			socket.on('disconnect', function (data) {
				globals.disconnected = true;
				console.log("nodejs disconnect");
				login.readySteps.nodeConnected = false;
				globals.runtimeInformation.nodeConnected = false;
			});

			socketListener.addPersistentListener("login-opencvqueue", function(data) {
				globals.openCVQueue.push(String(data.queue));
				console.log("opencvqueue recv "+data.queue);
			});

			socketListener.addPersistentListener('login-opencvdata', function(data) {
				var canvas = ID("loginCanvas");
				canvas.style.display = "block";
				var ctx = canvas.getContext('2d');
				var buffer = data.buffer;
				var queue = data.queue;
				var labels = data.labels;
				var confidences = data.confidences;
				var rects = data.rects;
				var approved = data.approved;
				var attempt = data.attemptNumber;
				var totalAttempts = data.totalAttempts;
				console.log("opencv pic queue: "+queue);
				console.log("ihavequeues: "+JSON.stringify(globals.openCVQueue));
				console.log("rects: "+JSON.stringify(rects)+"\nconfidences: "+JSON.stringify(confidences)+"\nlabels: "+JSON.stringify(labels)+"\napproved: "+approved);
				console.log("recieved opencv buffer");
				//console.log(buffer);
				if (globals.openCVQueue.indexOf(String(queue)) !== -1) {
					globals.openCVQueue.splice(globals.openCVQueue.indexOf(String(queue)),1); //remove from opencvqueue list
					var img = new Image();
					img.src = 'data:image/jpg;base64,' + buffer;
					img.onload = function(){
						console.log("onload img");
						ctx.drawImage(this, 0, 0);
					}
					if (approved) {
						login.approvedLogin();
					} else {
						canvas.style.display = "none";
						ID("attemptNumber").innerHTML = "Login attempt: "+attempt+" of "+totalAttempts;
					}
	  			} else {
	  				console.log("ignoring because client doesn't have queue")
	  			}
			});

			socketListener.addPersistentListener("processingError", function (data) {
				console.error("Error from nodejs: '"+data.error+"'");
				bootbox.alert("Server Error: "+data.error);
			});

			socketListener.addPersistentListener("login-passcodeapproval", function(data) {
				if (data.approved == true) {
					login.approvedLogin();
				}
			})

			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
			navigator.mediaDevices.getUserMedia({video: true}).then(function(localMediaStream) {
				globals.loginVideoStream = localMediaStream;
				globals.loginVideo = ID("loginvideo");
				globals.loginVideo.srcObject = localMediaStream;
				// Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
				// See crbug.com/110938.
				globals.loginVideo.onloadedmetadata = function(e) {
					console.log("Meta data for loginVideo loaded")
				  //globals.loginVideo.snapshot();
				};
				globals.loginVideo.oncanplaythrough = function(e) {
					console.log("Video loaded; sending snapshot")
					setTimeout(function(){
						login.readySteps.videoLoad = true;
					},500); //give some time for camera to adjust
				};
				console.log("lms: ",localMediaStream)
			}).catch(function(e){
				console.error("Error getting usermedia for login video, e="+JSON.stringify(e))
			});

			if (typeof annyang !== "undefined") {
				annyang.debug(true);
				/*annyang.addCommands({
					':data': function(data) {
						globals.voice.onSpeech(data);
					}
				});*/
				annyang.addCallback('error', function(e) {
					console.error("Error with annyang: "+JSON.stringify(e));
				});
				annyang.addCallback('errorNetwork', function() {
					console.error("Error with annyang connecting to internet");
				});
				annyang.addCallback('errorPermissionBlocked', function() {
					console.error("Error with annyang permission blocked");
				});
				annyang.addCallback('errorPermissionDenied', function() {
					console.error("Error with annyang permission denied");
				});

				annyang.addCallback('result', function(data) {
					console.log("result: "+JSON.stringify(data));
					/*if (SpeechKITT.isListening()) {
						SpeechKITT.toggleRecognition(); //disable speechKitt
					}*/
					globals.voice.onSpeech(data);
				});
				if (typeof SpeechKITT !== "undefined") {
					// Tell KITT to use annyang
					SpeechKITT.annyang();

					// Define a stylesheet for KITT to use
					SpeechKITT.setStylesheet('js/speechkittthemes/flat.css');
					SpeechKITT.displayRecognizedSentence(false); //broken so implemented my own
				} else {
					console.error("SpeechKITT not defined; annyang is active however");
				}
				if (typeof Speech !== "undefined") {
					if (Speech.isSupported) {
						var voices = Speech.listVoices();
						if (typeof Speech.setVoice("Google UK English Male") == "undefined") {
							console.warn("Defaulting to first system voice.");
							if (typeof Speech.setVoice(voices[0].name) == "undefined") {
								console.warn("Failed to set speech voice, waiting for voices load...");
								Speech.voicesLoaded = function() {
									alert("Voices loaded")
									var voices = Speech.listVoices();
									if (typeof Speech.setVoice("Google UK English Male") == "undefined") {
										console.warn("Defaulting to first system voice.");
										if (typeof Speech.setVoice(voices[0].name) == "undefined") {
											console.warn("Failed to set speech voice.");
										}
									}
								}
							}
						}
					} else {
						console.error("Client is not capable of speech synthesis.")
					}
				} else {
					console.error("Speech not defined; annyang is active however")
				}
			} else {
				console.error("Annyang is not defined; was it included in the source code?");
			}

			socketListener.addPersistentListener("speechMatchingResult", function(data) {
				console.log("recieved speech matching result: "+JSON.stringify(data));
				if (data.response == "" || data.response == " ") {
					data.response = "I'm sorry, I didn't quite catch that. Try again.";
				}
				var skittLT = document.getElementById("skitt-listening-text");
				globals.voice.speaker(data.response, function(){
					setTimeout(function(){
						if (typeof skittLT == "undefined" || skittLT == null) {
							console.error("Couldn't locate SKitt text on speech");
						} else {
							skittLT.innerHTML = globals.voice.defaultInstructions;
						}
					},globals.voice.defaultTextDelay);
				});
				if (typeof skittLT == "undefined" || skittLT == null) {
					console.error("Couldn't locate SKitt text on speech");
				} else {
					skittLT.innerHTML = data.response;
				}
			});

		</script>
		<!--Google maps script-->
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArwv2IQ00_3Z8_VQUwB1C9cJr0cujUnLk&callback=login.initialize"></script>
	</body>
</html>