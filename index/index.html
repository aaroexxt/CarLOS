<!DOCTYPE HTML>
<html>
    <head>
        <title>NodeTest</title>
    </head>
    <body>
        <h1>Hello world!</h1>
        <script src="socket.io.js"></script>
        <input id="pygame"></input>
        <p id="connectpy">Are you connected to python backend: No</p>
        <p id="connectnode">Are you connected to node backend: No</p>
        <script>
          var socket = io();
          var authkey = "";

          socket.emit('initweb', { data: 'ready' });
          console.log("Send ready socket");
          socket.on('connect', function (data) {
            document.getElementById('connectnode').innerHTML = "Are you connected to node backend: Yes";
            console.log("Connected to node.js backend")
          })
          socket.on('webdata', function (data) {
            console.log("Python script connected!");
            console.log("Authkey: "+data.authkey);
            if (typeof data.authkey == "undefined" || data.authkey == "undefined") {
                console.log("Authkey undefined, not changing")
            } else {
                authkey = data.authkey;
            }
            document.getElementById("pygame").onkeyup = function() {
                console.log("keyup elem");
                socket.emit('pydata', {authkey: authkey, data: document.getElementById("pygame").value})
            }
            document.getElementById('connectpy').innerHTML = "Are you connected to python backend: Yes";
          });
          socket.on('webready', function (data) {
            console.log("webready recieved from python initialization")
            socket.emit('webok', {data: "ok"});
          });
          socket.on('pydisconnect', function (data) {
            document.getElementById('connectpy').innerHTML = "Are you connected to python backend: No";
            console.log("Python disconnect")
          })
          socket.on('disconnect', function (data) {
            document.getElementById('connectnode').innerHTML = "Are you connected to node backend: No";
            console.log("nodejs disconnect")
          })

          setInterval(function(){
            socket.emit('validatekey', {authkey: authkey})
            socket.on('validatekey', function (data) {
                socket.off('validatekey');
                console.log("Authkey valid?: "+data.valid);
                if (data.valid == "false") {
                    if (confirm("Authkey has expired. Reload page?")) {
                        window.location.reload();
                    }
                }
            })
          }, 60000)
        </script>
    </body>
</html>